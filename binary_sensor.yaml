#
# BINARY_SENSOR
#
  # NMAP ==> prob_given_true: 0.8 - prob_given_false: 0.2
  #   - device_tracker.aac_iphone_nmap
  #   - device_tracker.mfc_iphone_nmap
  #   - device_tracker.paf_iphone_nmap
  #   - device_tracker.aaf_iphone_nmap
  #   - 'device_tracker.pi_rashmiphone'
  #   - 'device_tracker.pi_alokphone'

  # IOS APP ==> prob_given_true: 0.99 - prob_given_false: 0.10
  #   - device_tracker.aac_ios
  #   - device_tracker.mfc_ios
  #   - device_tracker.paf_ios
  #   - device_tracker.rashmiappiphone
  #   - device_tracker.alokiosiphone

  # OWNTRACK ==> prob_given_true: 0.99 - prob_given_false: 0.4
  #   - device_tracker.aac_iphone_owntrack
  #   - device_tracker.mfc_iphone_owntrack
  #   - device_tracker.rashmisiphone
  #   - device_tracker.myiphone

  # GEOFENCY ==> prob_given_true: 0.99 - prob_given_false: 0.1
  #   - device_tracker.b8b52a3bf0384e72a268705d9b06e496 #AAC
  #   - device_tracker.e3c67d6b51bf445ba241a0045bfe0222 #MFC
  #   - device_tracker.93e3d52336a54d4d898b204abdf3ee94 #PAF
  #   - device_tracker.bef743fa74f2464ba458612ad3e1c195 #AAF

  # BAYESIAN SENSORS
  #   - binary_sensor.family_home_mfc
  #   - binary_sensor.family_home_aac
  #   - binary_sensor.family_home_paf
  #   - binary_sensor.family_home_aaf

  - platform: 'bayesian'
    prior: 0.60
    name: 'baye_home_mfc'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.mfc_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.mfc_ios'  # IOS APP
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.mfc_iphone_owntrack' # OWNTRACK
        prob_given_true: 0.99
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.e3c67d6b51bf445ba241a0045bfe0222' # GEOFENCY
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.60
    name: 'baye_home_aac'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.aac_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aac_ios'  # IOS APP
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aac_iphone_owntrack' # OWNTRACK
        prob_given_true: 0.99
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.b8b52a3bf0384e72a268705d9b06e496' # GEOFENCY
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.66
    name: 'baye_home_paf'
    probability_threshold: 0.95  # temporalmente estuvo a 0.98
    observations:
      - entity_id: 'device_tracker.93e3d52336a54d4d898b204abdf3ee94' #PAF GEOFENCY
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.paf_ios'  # IOS APP
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.paf_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.66
    name: 'baye_home_aaf'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.bef743fa74f2464ba458612ad3e1c195' #AAF GEOFENCY
        prob_given_true: 0.99    # original 0.99
        prob_given_false: 0.1   # original 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aaf_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

  - platform: template
    sensors:
      # Sensores finales de control de presencia basados en el bayesian(on/off) AND input_boolean(on/off) de cada Uno.
      #
      family_home_aac:
        value_template: >-
          {% if is_state('sensor.family_home_aac','on')
              and is_state('binary_sensor.baye_home_aac','on') %}
            true
          {% else %}
            false
          {% endif %}

      family_home_mfc:
        value_template: >-
          {{ is_state('binary_sensor.baye_home_mfc','on')
              and is_state('sensor.family_home_mfc','on') }}

      family_home_paf:
        value_template: >-
          {{ is_state('binary_sensor.baye_home_paf','on')
              and is_state('sensor.family_home_paf','on') }}

      family_home_aaf:
        value_template: >-
          {{ is_state('binary_sensor.baye_home_aaf','on')
              and is_state('sensor.family_home_aaf','on') }}

      # Todos en Casa:  IF sensor.family_home >= sensor.family_sleep_home THEN TRUE
      family_all_home:
        value_template: >-
          {% if states('sensor.family_home')|int >= states('sensor.family_sleep_home')|int %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Todos en Casa'
        icon_template: mdi:home-map-marker
        entity_id:
          - sensor.family_home
          - sensor.family_sleep_home
      # Alguien en Casa:  IF sensor.family_home > 0 THEN TRUE
      family_any_home:
        value_template: >-
          {% if states('sensor.family_home')|int > 0 %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Alguien en Casa'
        icon_template: mdi:account-location
        entity_id:
          - sensor.family_home

      # Alarma SONOFF_SW1 SIRENA INTERIOR
      sonoff_basic_sw0:
        value_template: >-
          {% if is_state('switch.sonoff_basic_sw0','on') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Alarma Sirena Interior'
        icon_template: mdi:alarm-light

      # JARDIN - DEPURADORA PISCINA
      piscina_status:
        value_template: >-
          {% if is_state('switch.sonoff_pow_sw1','on') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Estado Depuradora on/off'
        icon_template: mdi:power

      piscina_dia_ejecucion:
        friendly_name: '¿Próxima Ejecución Hoy?'
        icon_template: mdi:calendar-check
        value_template: >-
          {% if is_state('input_select.piscina_programador_dias','Diario') and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Sábado') and now().weekday() | int == 5 and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Domingo') and now().weekday() | int == 6 and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Weekend') and now().weekday() | int in (5,6) and is_state('input_boolean.piscina_programador','on') %}
            true
          {% else %}
            false
          {% endif %}


