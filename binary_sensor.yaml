#
# BINARY_SENSOR
#
  # NMAP ==> prob_given_true: 0.8 - prob_given_false: 0.2
  #   - device_tracker.aac_iphone_nmap
  #   - device_tracker.mfc_iphone_nmap
  #   - device_tracker.paf_iphone_nmap
  #   - device_tracker.aaf_iphone_nmap

  # IOS APP ==> prob_given_true: 0.99 - prob_given_false: 0.10
  #   - device_tracker.aac_ios
  #   - device_tracker.mfc_ios
  #   - device_tracker.paf_ios

  # OWNTRACK ==> prob_given_true: 0.99 - prob_given_false: 0.4
  #   - device_tracker.aac_iphone_owntrack
  #   - device_tracker.mfc_iphone_owntrack
  #   - device_tracker.paf_iphone_owntrack

  # GEOFENCY ==> prob_given_true: 0.99 - prob_given_false: 0.1
  #   - device_tracker.b8b52a3b_f038_4e72_a268_705d9b06e496 #AAC
  #   - device_tracker.e3c67d6b_51bf_445b_a241_a0045bfe0222 #MFC
  #   - device_tracker.93e3d523_36a5_4d4d_898b_204abdf3ee94 #PAF OLD
  #   - device_tracker.863b93f2_f00f_4737_a35f_1ff0cce201a8 #PAF

  #   - device_tracker.bef743fa_74f2_464b_a458_612ad3e1c195 #AAF

  # BAYESIAN SENSORS
  #   - binary_sensor.family_home_mfc
  #   - binary_sensor.family_home_aac
  #   - binary_sensor.family_home_paf
  #   - binary_sensor.family_home_aaf

  - platform: 'bayesian'
    prior: 0.60
    name: 'baye_home_mfc'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.mfc_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.mfc_ios'  # IOS APP
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.mfc_iphone_owntrack' # OWNTRACK
        prob_given_true: 0.99
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.e3c67d6b_51bf_445b_a241_a0045bfe0222' #MFC
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.60
    name: 'baye_home_aac'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.aac_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aac_ios'  # IOS APP
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aac_iphone_owntrack' # OWNTRACK
        prob_given_true: 0.99
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.b8b52a3b_f038_4e72_a268_705d9b06e496' #AAC
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.60
    name: 'baye_home_paf'
    probability_threshold: 0.95  # temporalmente estuvo a 0.98
    observations:
      - entity_id: 'device_tracker.paf_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.paf_ios'  # IOS APP
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.paf_iphone_owntrack' # OWNTRACK
        prob_given_true: 0.99
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.863b93f2_f00f_4737_a35f_1ff0cce201a8' #PAF
        prob_given_true: 0.99
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    prior: 0.66
    name: 'baye_home_aaf'
    probability_threshold: 0.95
    observations:
      - entity_id: 'device_tracker.bef743fa_74f2_464b_a458_612ad3e1c195' #AAF
        prob_given_true: 0.99    # original 0.99
        prob_given_false: 0.1   # original 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aaf_ios'  # IOS APP
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.aaf_iphone_nmap'
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

  - platform: template
    sensors:
      # Test Alert Component
      test_alert_sensor:
        value_template: '{{ states.light.hue_estudio }}'
        friendly_name: 'Estado Hue Estudio'

      # Sensores finales de control de presencia basados en el bayesian(on/off) AND input_boolean(on/off) de cada Uno.
      #
      family_home_aac:
        value_template: >-
          {% if is_state('input_boolean.family_home_aac','on')
              and is_state('binary_sensor.baye_home_aac','on') %}
            true
          {% else %}
            false
          {% endif %}

      family_home_mfc:
        value_template: >-
          {% if is_state('input_boolean.family_home_mfc','on')
              and is_state('binary_sensor.baye_home_mfc','on') %}
            true
          {% else %}
            false
          {% endif %}

      family_home_paf:
        value_template: >-
          {% if is_state('input_boolean.family_home_paf','on')
              and is_state('binary_sensor.baye_home_paf','on') %}
            true
          {% else %}
            false
          {% endif %}

      family_home_aaf:
        value_template: >-
          {% if is_state('input_boolean.family_home_aaf','on')
              and is_state('binary_sensor.baye_home_aaf','on') %}
            true
          {% else %}
            false
          {% endif %}

      # Todos en Casa:  IF sensor.family_home >= sensor.family_sleep_home THEN TRUE
      family_all_home:
        value_template: >-
          {% if states('sensor.family_sleep_home')|int > 0
              and states('sensor.family_home')|int >= states('sensor.family_sleep_home')|int %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '¿Todos?' #'Todos en Casa'
        icon_template: mdi:home-map-marker
        entity_id:
          - sensor.family_home
          - sensor.family_sleep_home
      # Alguien en Casa:  IF sensor.family_home > 0 THEN TRUE
      family_any_home:
        value_template: >-
          {% if states('sensor.family_home')|int > 0 %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '¿Alguien?' #'Alguien en Casa'
        icon_template: mdi:home
        entity_id:
          - sensor.family_home

      # Alarma SONOFF_SW1 SIRENA INTERIOR
      esphome_bas_sw0:
        value_template: >-
          {% if is_state('switch.esphome_bas_sw0','on') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Alarma Sirena Interior'
        icon_template: mdi:alarm-light

      # Alarma SONOFF POW Rack
      esphome_pow_sw2_switch:
        value_template: >-
          {% if is_state('switch.esphome_pow_sw2','on') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Corriente Rack'
        icon_template: mdi:toggle-switch

      # JARDIN - DEPURADORA PISCINA
      piscina_status:
        value_template: >-
          {% if is_state('switch.esphome_pow_sw1','on') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'Estado Depuradora on/off'
        icon_template: mdi:power

      piscina_dia_ejecucion:
        friendly_name: '¿Próxima Ejecución Hoy?'
        icon_template: mdi:calendar-check
        value_template: >-
          {% if is_state('input_select.piscina_programador_dias','Diario') and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Sábado') and now().weekday() | int == 5 and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Domingo') and now().weekday() | int == 6 and is_state('input_boolean.piscina_programador','on') %}
            true
          {% elif is_state('input_select.piscina_programador_dias','Weekend') and now().weekday() | int in (5,6) and is_state('input_boolean.piscina_programador','on') %}
            true
          {% else %}
            false
          {% endif %}

      # SAI APC Rack
      ups_status:
        value_template: >-
          {% if is_state('sensor.ups_status','ONLINE') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: 'SAI APC·700 Rack'
        icon_template: mdi:car-battery


      #
      # NMAP - 01 - 09 - NETWORK DEVICES
      # =====================================================================
      #
      nmap_02_nas_time_capsule:
        value_template: >-
          {% if is_state('device_tracker.nmap_02_nas_time_capsule','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '02 NAS Apple Time Capsule'
        icon_template: mdi:nas
        entity_id: device_tracker.nmap_02_nas_time_capsule

      nmap_04_router_wifi_zte:
        value_template: >-
          {% if is_state('device_tracker.nmap_04_router_wifi_zte','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '04 Router WIFI ZTE Home Station'
        icon_template: mdi:wifi
        entity_id: device_tracker.nmap_04_router_wifi_zte

      nmap_05_router_wifi_tplink:
        value_template: >-
          {% if is_state('device_tracker.nmap_05_router_wifi_tplink','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '05 Router Wifi TP-Link Pasillo'
        icon_template: mdi:wifi
        entity_id: device_tracker.nmap_05_router_wifi_tplink

      nmap_06_router_wifi_jadin:
        value_template: >-
          {% if is_state('device_tracker.nmap_06_router_wifi_jadin','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '06 Router WIFI Linksys Jardín'
        icon_template: mdi:wifi
        entity_id: device_tracker.nmap_06_router_wifi_jadin

      nmap_07_switch_salon:
        value_template: >-
          {% if is_state('device_tracker.nmap_07_switch_salon','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '07 Switch TK-LINK Salón'
        icon_template: mdi:switch
        entity_id: device_tracker.nmap_07_switch_salon

      nmap_09_switch_estudio:
        value_template: >-
          {% if is_state('device_tracker.nmap_09_switch_estudio','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '09 Switch TK-LINK Estudio'
        icon_template: mdi:switch
        entity_id: device_tracker.nmap_09_switch_estudio

      #
      # NMAP - 10 - 19 - HOME & HUB DEVICES
      # =====================================================================
      #
      nmap_12_p2pcam_estudio:
        value_template: >-
          {% if is_state('device_tracker.nmap_12_p2pcam_estudio','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '12 P2P IPcam Estudio'
        icon_template: mdi:cctv
        entity_id: device_tracker.nmap_12_p2pcam_estudio

      nmap_13_p2pcam_cocina:
        value_template: >-
          {% if is_state('device_tracker.nmap_13_p2pcam_cocina','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '13 P2P IPcam Cocina'
        icon_template: mdi:cctv
        entity_id: device_tracker.nmap_13_p2pcam_cocina

      nmap_17_philips_hue:
        value_template: >-
          {% if is_state('device_tracker.nmap_17_philips_hue','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '17 Hub Philips Hue'
        icon_template: mdi:lightbulb
        entity_id: device_tracker.nmap_17_philips_hue

      nmap_18_xiaomi_gateway:
        value_template: >-
          {% if is_state('device_tracker.nmap_18_xiaomi_gateway','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '18 Xiaomi Aqara Gateway'
        icon_template: mdi:alarm-plus
        entity_id: device_tracker.nmap_18_xiaomi_gateway
      #
      # NMAP - 20 - 29 - MEDIA DEVICES
      # =====================================================================
      #
      nmap_20_fire_tvstick:
        value_template: >-
          {% if is_state('device_tracker.nmap_20_fire_tvstick','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '20 Fire TV Stick'
        icon_template: mdi:youtube-tv
        entity_id: device_tracker.nmap_20_fire_tvstick

      nmap_21_apple_tv:
        value_template: >-
          {% if is_state('device_tracker.nmap_21_apple_tv','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '21 Apple TV'
        icon_template: mdi:youtube-tv
        entity_id: device_tracker.nmap_21_apple_tv

      ping_22_amazon_alexa:
        value_template: >-
          {% if is_state('device_tracker.ping_22_amazon_alexa','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '22 Amazon Alexa'
        icon_template: mdi:amazon-alexa
        entity_id: device_tracker.ping_22_amazon_alexa

      nmap_23_deco_tv_salon:
        value_template: >-
          {% if is_state('device_tracker.nmap_23_deco_tv_salon','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '23 Deco TV Salon'
        icon_template: mdi:television-box
        entity_id: device_tracker.nmap_23_deco_tv_salon

      ping_23_decotv_salon:
        value_template: >-
          {% if is_state('device_tracker.ping_23_decotv_salon','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '23 Deco TV Salon'
        icon_template: mdi:television-box
        entity_id: device_tracker.nmap_23_deco_tv_salon

      ping_24_decotv_estudio:
        value_template: >-
          {% if is_state('device_tracker.ping_24_decotv_estudio','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '24 Deco TV Estudio'
        icon_template: mdi:television-box
        entity_id: device_tracker.nmap_23_deco_tv_salon

      nmap_24_deco_tv_estudio:
        value_template: >-
          {% if is_state('device_tracker.nmap_24_deco_tv_estudio','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '24 Deco TV Estudio'
        icon_template: mdi:television-box
        entity_id: device_tracker.nmap_24_deco_tv_estudio

      nmap_25_tv_sony_salon:
        value_template: >-
          {% if is_state('device_tracker.nmap_25_tv_sony_salon','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '25 TV Sony Salon'
        icon_template: mdi:television
        entity_id: device_tracker.nmap_25_tv_sony_salon

      nmap_26_sony_tv_estudio:
        value_template: >-
          {% if is_state('device_tracker.nmap_26_sony_tv_estudio','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '26 TV Sony Estudio'
        icon_template: mdi:television
        entity_id: device_tracker.nmap_26_sony_tv_estudio

      nmap_27_sony_ps4_wifi:
        value_template: >-
          {% if is_state('device_tracker.nmap_27_sony_ps4_wifi','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '27 Sony PS4 Wifi'
        icon_template: mdi:gamepad-variant
        entity_id: device_tracker.nmap_27_sony_ps4_wifi

      #
      # NMAP - 50 - 29 - MOBILE DEVICES
      # =====================================================================
      #
      nmap_52_iphone_aac:
        value_template: >-
          {% if is_state('device_tracker.aac_iphone_nmap','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '52 Iphone 7S+ AAC'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.aac_iphone_nmap

      nmap_53_iphone_mfc:
        value_template: >-
          {% if is_state('device_tracker.mfc_iphone_nmap','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '53 Iphone 6S MFC'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.mfc_iphone_nmap


      nmap_54_iphone_paf:
        value_template: >-
          {% if is_state('device_tracker.paf_iphone_nmap','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '54 Iphone 6S PAF'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.paf_iphone_nmap


      nmap_55_iphone_aaf:
        value_template: >-
          {% if is_state('device_tracker.aaf_iphone_nmap','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '55 Iphone 6S+ AAF'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.aaf_iphone_nmap

      nmap_56_ipad_air2:
        value_template: >-
          {% if is_state('device_tracker.nmap_56_ipad_air2','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '56 Apple Ipad Air2'
        icon_template: mdi:tablet-ipad
        entity_id: device_tracker.nmap_56_ipad_air2

      ping_57_amazon_kindle:
        value_template: >-
          {% if is_state('device_tracker.ping_57_amazon_kindle','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '57 Amazon Kindle'
        icon_template: mdi:tablet-android
        entity_id: device_tracker.ping_57_amazon_kindle

      nmap_58_ipad_mini4:
        value_template: >-
          {% if is_state('device_tracker.nmap_58_ipad_mini4','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '58 Apple Ipad Mini4'
        icon_template: mdi:tablet-ipad
        entity_id: device_tracker.nmap_58_ipad_mini4

      nmap_59_apple_watch:
        value_template: >-
          {% if is_state('device_tracker.nmap_59_apple_watch','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '59 Apple Watch'
        icon_template: mdi:watch
        entity_id: device_tracker.nmap_59_apple_watch

      nmap_80_phone_conchi:
        value_template: >-
          {% if is_state('device_tracker.nmap_80_phone_conchi','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '80 Alvarea.net Phone Conchi'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.nmap_80_phone_conchi

      nmap_81_phone_ale:
        value_template: >-
          {% if is_state('device_tracker.nmap_81_phone_ale','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '81 Alvarea.net Phone Ale'
        icon_template: mdi:cellphone-iphone
        entity_id: device_tracker.nmap_81_phone_ale
        #device_class: router
        #attribute_template: "{{ state_attr('device_tracker.nmap_81_phone_ale','ip') }}"

      #
      # NMAP - 60 - 69 - COMPUTER LAPTOP DEVICES
      # =====================================================================
      #
      nmap_60_macbook_pro_lan:
        value_template: >-
          {% if is_state('device_tracker.nmap_60_macbook_pro_lan','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '60 Apple Macbook Pro LAN'
        icon_template: mdi:laptop-mac
        entity_id: device_tracker.nmap_60_macbook_pro_lan

      nmap_61_macbook_pro_wifi:
        value_template: >-
          {% if is_state('device_tracker.nmap_61_macbook_pro_wifi','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '61 Apple Macbook Pro Wifi'
        icon_template: mdi:laptop-mac
        entity_id: device_tracker.nmap_61_macbook_pro_wifi

      nmap_63_macbook_air_paf:
        value_template: >-
          {% if is_state('device_tracker.nmap_63_macbook_air_paf','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '63 Alvarea.net Macbook Air PAF'
        icon_template: mdi:laptop-mac
        entity_id: device_tracker.nmap_63_macbook_air_paf

      nmap_65_elitebook_hk:
        value_template: >-
          {% if is_state('device_tracker.nmap_65_elitebook_hk_wifi','home')
             or is_state('device_tracker.nmap_66_elitebook_hk_lan','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '65 Alvarea.net Elitebook Heineken'
        icon_template: mdi:laptop
        entity_id: device_tracker.nmap_65_elitebook_hk_wifi

      nmap_67_acer_notebook:
        value_template: >-
          {% if is_state('device_tracker.nmap_67_acer_notebook','home') %}
            true
          {% else %}
            false
          {% endif %}
        friendly_name: '67 Alvarea.net Netbook Acer Aspire'
        icon_template: mdi:laptop
        entity_id: device_tracker.nmap_67_acer_notebook

