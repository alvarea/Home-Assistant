#-----------------------------------------------------------------------------#
#                                                                             #
# ALARMA: Armado y Control de la Alarma                                       #
#                                                                             #
#-----------------------------------------------------------------------------#

#
# REGLA: ARMADO COMPLETADO
#
- id: A0_alarma_armado_ok
  alias: 'A0 Alarma Armado OK'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'armed_home'
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'armed_away'
  action:
    - service: script.turn_on
      entity_id: script.xiaomi_play_off

#
# REGLA: ALARMA MODO TRANSICION PENDING
#
#pre_pending_state: disarmed
#post_pending_state: armed_away
# Alarm control panel en la transición desde Disarmed a Armed Away:
#   post_pending_state: armed_away
#   pre_pending_state: disarmed
#   code_format: null
#
  #condition:
  #  condition: template
  #  value_template: >-
  #    {% if is_state_attr('alarm_control_panel.ha','post_pending_state','armed_away') %}
  #      true
  #    {%else%}
  #      false
  #    {%endif%}
#
- id: A1_alarma_disarmed_pending
  alias: 'A1 Alarma Armando'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'disarmed'
      to: 'pending'
  action:
    # Notifica Evento
    #>>> Estado Alarma: {{ state('alarm_control_panel.ha') }}
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*AVISO ALARMA*'
          message: >
            >>> ESTADO: ARMANDO HOMMER

    # Stop ringtone sound
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_gateway
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_gateway
        ringtone_id: "10005"
        ringtone_vol: "50"

- id: A2_alarma_armed_pending
  alias: 'A2 Alarma Desarmando'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'armed_away'
      to: 'pending'
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'armed_home'
      to: 'pending'
  action:
    # Notifica Evento
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*AVISO ALARMA*'
          message: >
            >>> ESTADO: DESARMANDO HOMMER

    # Stop ringtone sound
    - service: xiaomi_aqara.stop_ringtone
      data:
        gw_mac: !secret xiaomi_gateway
    - service: xiaomi_aqara.play_ringtone
      data_template:
        gw_mac: !secret xiaomi_gateway
        ringtone_id: "10004"
        ringtone_vol: "50"

    # Activa Sonido Xiaomi en Bucle
    ### Turn off gateway mute to play sound
    #- service: input_boolean.turn_off
    #  entity_id: input_boolean.mute_xiaomi_gw_sounds
    ### Play ringtone sound in loop until arm is done
    #- service: script.turn_on
    #  entity_id: script.xiaomi_play_sel_sound

#
# REGLA: NOTIFICACION COMPLETA DESARMADO
#
- id: A3_alarma_activa_desarmada
  alias: 'A3 Alarma Activa a Desarmado'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'triggered'
      to: 'disarmed'
  action:
    - service: script.turn_on
      entity_id: script.xiaomi_play_off
    # Script Notificación Alarma
    - service: script.turn_on
      entity_id: script.notifica_alarma
      data:
        variables:
          title: '*ALARMA*'
          message: >
            >>> URGENTE: DESARMADO OK
#
# REGLA: ALARMA ACTIVA SIRENA + NOTIFICACION COMPLETA
#
- id: A4_alarma_disparada
  alias: 'A4 Alarma Disparada'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'triggered'
  action:
    # Desactiva Sonido Warning en Xiaomi_GW
    - service: script.turn_on
      entity_id: script.xiaomi_play_off

    # Script Notificación Alarma
    - service: script.turn_on
      entity_id: script.notifica_alarma
      data:
        variables:
          title: '*ALARMA*'
          message: >
            >>> URGENTE: SENSOR DISPARADO

            >>> ZONA: {{ states('sensor.alarm_zone') }}

    # Activa Sonido Alarma en Xiaomi_GW
    - service: script.turn_on
      entity_id: script.xiaomi_play_sel_sound_alarma

    # Script Envio Fotos Cámaras Telegram
    #- service: script.turn_on
    #  entity_id: script.telegram_alarm_send_photo

#
# REGLA: TRIGGER ALARMA POR SENSOR EN ARMADO AWAY
#
- id: A5_alarma_trigger_armed_away
  alias: 'A5 Alarma Trigger Armado Away'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_sensor_158d0001e55903      # Sensor Presencia Entrada
        - binary_sensor.door_window_sensor_158d00022b393c # Sensor Puerta Entrada
        - binary_sensor.motion_sensor_158d0001e05661      # Sensor Presencia Salón
        - binary_sensor.door_window_sensor_158d000201e2e7 # Sensor Puerta Salón
        - binary_sensor.motion_sensor_158d0001e464a6      # Sensor Presencia Estudio
        - binary_sensor.door_window_sensor_158d000201dddb # Sensor Ventana PAF
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.ha
        state: armed_away
      #- condition: state
      #  entity_id: binary_sensor.family_any_home
      #  state: 'off'
  action:
    - service: python_script.meta_alarm_trigger
      data_template:
        entity_id: '{{trigger.entity_id}}'
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.ha

#
# REGLA: TRIGGER ALARMA POR SENSOR EN ARMADO HOME
#
- id: A6_alarma_trigger_armed_home
  alias: 'A6 Alarma Trigger Armado Home'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.door_window_sensor_158d00022b393c # Sensor Puerta Entrada
        - binary_sensor.door_window_sensor_158d000201e2e7 # Sensor Puerta Salón
        - binary_sensor.door_window_sensor_158d000201dddb # Sensor Ventana PAF
      from: 'off'
      to: 'on'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha
      state: armed_home
  action:
    - service: python_script.meta_alarm_trigger
      data_template:
        entity_id: '{{trigger.entity_id}}'
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.ha
#
#=====================================================
#
- id: A8_alarma_boton_panico_on
  alias: 'A8 Alarma Boton Panico On'
  trigger:
    platform: state
    entity_id: input_boolean.panic_button
    from: 'off'
    to: 'on'
  action:
    - service: script.turn_on
      entity_id: script.alarma_sirena_on
    - service: script.turn_on
      entity_id: script.notifica_alarma
      data:
        variables:
          title: '*ALARMA*'
          message: >
            >>> URGENTE: BOTON PANICO ACTIVADO

- id: A9_alarma_boton_panico_off
  alias: 'A9 Alarma Boton Panico Off'
  trigger:
    platform: state
    entity_id: input_boolean.panic_button
    from: 'on'
    to: 'off'
  action:
    - service: script.turn_on
      entity_id: script.alarma_sirena_off
    - service: script.turn_on
      entity_id: script.notifica_alarma
      data:
        variables:
          title: '*ALARMA*'
          message: >
            >>> URGENTE: BOTON PANICO APAGADO

- id: A10_alarma_sirena_off
  alias: 'A10 Alarma Sirena Off'
  trigger:
    platform: state
    entity_id: input_boolean.alarm_siren
    to: 'off'
  action:
    - service: script.turn_on
      entity_id: script.alarma_sirena_off

#-----------------------------------------------------------------------------#
#                                                                             #
# FAMILY META TRACKER HOME/AWAY                                               #
#                                                                             #
#-----------------------------------------------------------------------------#

# NMAP ==> prob_given_true: 0.8 - prob_given_false: 0.2
#   - entity_id: device_tracker.aac_iphone_nmap
#   - entity_id: device_tracker.mfc_iphone_nmap
#   - entity_id: 'device_tracker.pi_rashmiphone'
#   - entity_id: 'device_tracker.pi_alokphone'

# IOS APP ==> prob_given_true: 0.99 - prob_given_false: 0.10
#   - device_tracker.aac_ios
#   - device_tracker.mfc_ios
#   - entity_id: 'device_tracker.rashmiappiphone'
#   - entity_id: 'device_tracker.alokiosiphone'

# OWNTRACK ==> prob_given_true: 0.99 - prob_given_false: 0.4
#   - device_tracker.aac_iphone_owntrack
#   - device_tracker.mfc_iphone_owntrack
#   - entity_id: 'device_tracker.rashmisiphone'
#   - entity_id: 'device_tracker.myiphone'

# GEOFENCY ==> prob_given_true: 0.99 - prob_given_false: 0.1
#   - device_tracker.b8b52a3bf0384e72a268705d9b06e496 #AAC
#   - device_tracker.e3c67d6b51bf445ba241a0045bfe0222 #MFC
#   - device_tracker.93e3d52336a54d4d898b204abdf3ee94 #PAF
#   - device_tracker.bef743fa74f2464ba458612ad3e1c195 #AAF
#   - entity_id: 'device_tracker.6b00226793104872afb9248f8a45f957'
#   - entity_id: 'device_tracker.3a196aa7e85e4ab5bee4e3d3af667a09'

- id: update_meta_tracker
  alias: "Update Device Meta Tracker"
  initial_state: 'on'
  trigger:
    # Delayed action for router-based and Owntracks trackers that are not 100% reliable
    - platform: state
      entity_id:
        - device_tracker.aac_iphone_nmap      # NMAP
        - device_tracker.mfc_iphone_nmap      # NMAP
        - device_tracker.paf_iphone_nmap      # NMAP
        - device_tracker.aaf_iphone_nmap      # NMAP
        - device_tracker.aac_iphone_owntrack  # OWNTRACK
        - device_tracker.mfc_iphone_owntrack  # OWNTRACK
      to: 'not_home'
      for: '00:07:00'
    - platform: state
      entity_id:
        - device_tracker.aac_iphone_owntrack  # OWNTRACK
        - device_tracker.mfc_iphone_owntrack  # OWNTRACK
      to: 'home'
    - platform: state
      entity_id:
        - device_tracker.aac_iphone_nmap      # NMAP
        - device_tracker.mfc_iphone_nmap      # NMAP
        - device_tracker.paf_iphone_nmap      # NMAP
        - device_tracker.aaf_iphone_nmap      # NMAP
      to: 'home'
      for: '00:00:30'
    - platform: state
      entity_id:
        - device_tracker.aac_ios                          # IOSAPP
        - device_tracker.mfc_ios                          # IOSAPP
        - device_tracker.b8b52a3bf0384e72a268705d9b06e496 # AAC
        - device_tracker.e3c67d6b51bf445ba241a0045bfe0222 # MFC
        - device_tracker.93e3d52336a54d4d898b204abdf3ee94 # PAF
        - device_tracker.bef743fa74f2464ba458612ad3e1c195 # AAF
  action:
    - service: script.updatetracker
      data_template:
        entityid: '{{trigger.entity_id}}'
        fromstate: '{{trigger.from_state.state}}'
        tostate: '{{trigger.to_state.state}}'

#-----------------------------------------------------------------------------#
#                                                                             #
# TRACKING FAMILY AT HOME: Control Home/Away                                  #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: T01_family_away
  alias: 'T01 Family Away'
  trigger:
    # Ya no hay nadie en casa
    platform: state
    entity_id: binary_sensor.family_any_home
    from: 'on'
    to: 'off'
  action:
    # Script Luces Apagado Total
    - service: script.turn_on
      entity_id: script.luces_off
    # Servicio Alarma Armado Total
    - service: alarm_control_panel.alarm_arm_away
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code
    # Notifica a Familia NADIE en Casa
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*FAMILY_HOME: NO*'
          message: >
            >>> EVENTO: Último en Salir {{ states('sensor.family_last_tracking') }}

- id: T02_family_at_home
  alias: 'T02 Family at Home'
  trigger:
    # Hay alguien en casa
    - platform: state
      entity_id: binary_sensor.family_any_home
      from: 'off'
      to: 'on'
  action:
    # Script encendido Luz piloto si es de noche
    - service: script.turn_on
      entity_id: script.luces_on_family_home
    # Servicio Alarma Desarmado
    - service: alarm_control_panel.alarm_disarm
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code
    # Notifica a Familia Alguien en Casa
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*FAMILY_HOME: SI*'
          message: >
            >>> EVENTO: Primero en Entrar {{ states('sensor.family_last_tracking') }}

#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE CONTROL DE LUCES Y ALUMBRADO                                      #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: L01_luces_on_exterior_sunset
  alias: 'L01 Luces On Exterior Sunset'
  trigger:
    - platform: sun
      event: sunset
      offset: "+00:15:00"
    #- condition: time
    #  before: '23:59:00'
  action:
    - service: switch.turn_on
      entity_id: switch.wall_switch_right_158d0002236e75
    # Notifica Evento
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: ON*'
          message: >
            >>> EVENTO: Puesta de sol hace 15min

            >>> LUCES: Alumbrado Exterior ON

- id: L02_luces_off_exterior_all_family_home
  alias: 'L02 Luces Off Exterior All Family Home'
  trigger:
    # Los que duermen ya están en casa
    - platform: state
      entity_id: binary_sensor.family_all_home
      from: 'off'
      to: 'on'
    - platform: time
      at: '00:01:00'
  condition:
    condition: and
    conditions:
      - condition: time
        after: '00:00:00'
      - condition: state
        entity_id: switch.wall_switch_right_158d0002236e75 # Luces exterior
        state: 'on'
      # Están todos en casa
      - condition: state
        entity_id: binary_sensor.family_all_home
        state: 'on'
  action:
    - delay: 0:05
    - service: switch.turn_off
      entity_id: switch.wall_switch_right_158d0002236e75
    # Notifica a Familia
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: OFF*'
          message: >
            >>> EVENTO: Es Medianoche y todos en casa

            >>> LUCES: Alumbrado Exterior Off

- id: L03_luces_off_exterior_sunrise
  alias: 'L03 Luces Off Exterior Amanecer -4h'
  trigger:
    - platform: sun
      event: sunrise
      offset: "-04:00:00"
  condition:
    condition: state
    entity_id: switch.wall_switch_right_158d0002236e75
    state: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.wall_switch_right_158d0002236e75
    # Notifica a Familia
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: OFF*'
          message: >
            >>> EVENTO: Amanecer en 4 horas

            >>> LUCES: Alumbrado Exterior Off

- id: L04_luces_on_salon_sunset
  alias: 'L04 Luces On Salon Puesta Sol -1h'
  trigger:
    - platform: sun
      event: sunset
      offset: "-01:00:00"
  condition:
    # Hay alguien en casa
    condition: state
    entity_id: group.family_home_grp
    state: 'on'
  action:
    - service: light.turn_on
      entity_id: light.room_salon_tv
    # Notifica a Familia
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: ON*'
          message: >
            >>> EVENTO: El sol se pone en 1hora

            >>> LUCES: Luces Salón On

- id: L05_luces_off_midnight
  alias: 'L05 Luces Off Medianoche'
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    # Script Luces Apagado Interior Casa
    - service: script.turn_on
      entity_id: script.luces_off
    # Notifica a Familia
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: OFF*'
          message: >
            >>> EVENTO: Medianoche

            >>> LUCES: Luces Interior Off

- id: L06_luces_off_home_sunrise
  alias: 'L06 Luces Off Amanecer'
  trigger:
    - platform: sun
      event: sunrise
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: group.luces_salon_grp
        state: 'on'
      - condition: state
        entity_id: group.luces_estudio_grp
        state: 'on'
      - condition: state
        entity_id: group.luces_cocina_grp
        state: 'on'
  action:
    # Script Luces Apagado Interior Casa
    - service: script.turn_on
      entity_id: script.luces_off
    # Notifica a Familia
    - service: script.turn_on
      entity_id: script.notifica_evento
      data:
        variables:
          title: '*LUCES: OFF*'
          message: >
            >>> EVENTO: Luces encendidas al amanecer

            >>> LUCES: Apagado total

- id: L07_luces_on_entrada_on_sensor
  alias: 'L07 Luces On Entrada Según Sensor'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_sensor_158d0001e55903
        - binary_sensor.door_window_sensor_158d00022b393c
      to: 'on'
  condition:
    condition: or  # 'when dark' condition: either after sunset or before sunrise
    conditions:
      - condition: sun
        after: sunset
        after_offset: "-1:00:00"
      - condition: sun
        before: sunrise
        before_offset: "+3:00:00"
  #condition:
    #condition: numeric_state
    #entity_id: sensor.temperature
    #below: 10
    #condition: template
    #value_template: '{{ states.sensor.illumination_158d0001e55903.state < 10 }}'
  action:
    - service: light.turn_on
      entity_id: light.hue_entrada
      data:
        brightness: 120
        rgb_color: [255, 0, 0]

- id: L08_luz_off_entrada_off_sensor
  alias: 'L08 Luces Off Entrada Según Sensor'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_sensor_158d0001e55903
        - binary_sensor.door_window_sensor_158d00022b393c
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  action:
    - service: light.turn_off
      entity_id: light.hue_entrada

- id: L09_luces_on_estudio_on_sensor
  alias: 'L09 Luces On Estudio Según Sensor'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001e464a6
      to: 'on'
  condition:
    condition: or  # 'when dark' condition: either after sunset or before sunrise
    conditions:
      - condition: sun
        after: sunset
        after_offset: "-0:15:00"
      - condition: sun
        before: sunrise
        before_offset: "1:30:00"
  action:
    - service: light.turn_on
      entity_id: light.hue_estudio
      data:
        brightness: 180
        rgb_color: [255, 187, 106]

- id: L10_luz_off_estudio_off_sensor
  alias: 'L10 Luces Off Estudio Según Sensor'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001e464a6
      to: 'off'
      for:
        minutes: 10
  action:
    - service: light.turn_off
      entity_id: light.hue_estudio

#-----------------------------------------------------------------------------#
#                                                                             #
# ARRANQUE/PARADA DEL SISTEMA                                                 #
#                                                                             #
#-----------------------------------------------------------------------------#
- id: hass_startup_automation
  alias: hass_startup_scripts
  trigger:
    platform: homeassistant
    # Event can also be 'shutdown'
    event: start
  action:
    # Para todas las reglas durante el arranque del sistema
    - service: automation.turn_off
      data:
        entity_id:
          - group.all_automations
    #
    # Llamada al script python para inicializar meta-trackers
    - service: script.reset_meta_tracker
    #
    # Llamada al script python para inicializar meta-alarm_trigger
    - service: script.reset_meta_alarm_trigger
    #
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople
    #
    # 30" espera y arranca reglas
    - delay: 30
    - service: automation.turn_on
      data:
        entity_id:
          - group.all_automations

#
# CERTBOT SSL CERTIFICATE: ALERT TO WARN US IF SOMETHING WENT WRONG.
#
- id: S1_ssl_expiry_notification
  alias: 'S1 SSL expiry notification'
  trigger:
    platform: numeric_state
    entity_id: sensor.ssl_certificate_expiry
    below: 21
  action:
    service: script.turn_on
    entity_id: script.notifica_evento
    data:
      variables:
        title: '*CERTIFICADO SSL*'
        message: >
          >>> EVENTO: El certificado SSL expira en {{ states('sensor.ssl_certificate_expiry') }}

#
# ALARMA AUTOMATICA SENSOR HUMO/FUEGO COCINA
#
- id: F1_alarma_fuego_cocina
  alias: 'F1 Alarma Fuego Cocina'
  trigger:
    - platform: state
      entity_id: binary_sensor.smoke_sensor_158d0001fd321c
      from: 'off'
      to: 'on'
  action:
    - service: script.turn_on
      entity_id: script.alarma_siren_on
    # Script Notificación Alarma
    - service: script.turn_on
      entity_id: script.notifica_alarma
      data:
        variables:
          title: '*ALARMA FUEGO*'
          message: >
            >>> URGENTE: ALARMA FUEGO COCINA

    # Script Envio Fotos Cámaras Telegram
    - service: script.turn_on
      entity_id: script.telegram_alarm_send_photo
